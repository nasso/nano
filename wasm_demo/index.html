<html>

<head>
    <title>Nano Tek Spicier</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link rel="icon" type="image/gif"
        href="data:image/gif;base64,R0lGODlhEAAQAIAAAAAAAAAAACH5BAkAAAEALAAAAAAQABAAAAIgjI+py+0PEQiT1lkNpppnz4HfdoEH2W1nCJRfBMfyfBQAOw==" />
    <script src="nts.js" type="module"></script>
    <style>
        body {
            background: #000;
            color: #ddd;
            margin: 0 auto;
            padding: 0 8px;

            max-width: 80ch;
        }

        #source {
            resize: none;
            overflow: hidden;
            min-height: 50px;
            width: 100%;
        }

        button:focus-visible,
        button:active,
        .panel:focus-visible {
            outline: none;
            background: #222;
        }

        .panel,
        button {
            margin: 0;
            margin-top: 8px;
            background: #111;
            color: #eee;
            padding: 16px;
            border-radius: 8px;
            border: none;

            transition: background-color 30ms;
        }

        #run {
            float: right;
        }
    </style>
</head>

<body>
    <textarea id="source" class="panel">
        # NOR gate

        .chipsets:
        input a
        input b
        output out
        not not_a
        not not_b
        and and

        .links:
        a:1 not_a:1
        b:1 not_b:1
        not_a:2 and:1
        not_b:2 and:2
        and:3 out:1
    </textarea>
    <button id="run">Run again</button>
    <pre class="panel" id="out"></pre>

    <script type="module">
        import createNts from "./nts.js";

        const outputElem = document.getElementById("out");
        const sourceElem = document.getElementById("source");
        const runBtn = document.getElementById("run");

        function formatNtsSource() {
            source.value = source.value
                .trim()
                .split("\n")
                .map((line) => line.trim())
                .join("\n");
        }

        function clear() {
            outputElem.innerText = "";
        }

        function print(msg) {
            outputElem.innerText += msg;
        }

        function println(msg = "") {
            print(`${msg}\n`);
        }

        function displayPins(nts, circuit) {
            const pins = circuit.pins;
            const pinout = circuit.pinout;
            const pinNames = pins.keys();
            const pinCount = pinNames.size();

            for (let i = 0; i < pinCount; i++) {
                const name = pinNames.get(i);
                const id = pins.get(name);
                const mode = pinout.get(id);
                const value = circuit.read(id);
                let valueStr = "?";

                switch (value) {
                    case nts.Tristate.UNDEFINED:
                        valueStr = "U";
                        break;
                    case nts.Tristate.FALSE:
                        valueStr = "0";
                        break;
                    case nts.Tristate.TRUE:
                        valueStr = "1";
                        break;
                }

                if (mode == nts.PinMode.INPUT) {
                    println(`${name} <- ${valueStr}`);
                } else if (mode == nts.PinMode.OUTPUT) {
                    println(`${name} -> ${valueStr}`);
                } else {
                    println(`${name} <-> ${valueStr}`);
                }
            }
        }

        function runDemo(nts) {
            clear();

            const source = sourceElem.value;

            print("Creating circuit...");
            const circuit = new nts.NtsCircuit(source);
            println(" ok");

            displayPins(nts, circuit);
            println();

            println("Testing circuit...");

            circuit.write(1, nts.Tristate.FALSE);
            circuit.write(2, nts.Tristate.FALSE);
            circuit.simulate();
            displayPins(nts, circuit);
            println();

            circuit.write(1, nts.Tristate.TRUE);
            circuit.write(2, nts.Tristate.FALSE);
            circuit.simulate();
            displayPins(nts, circuit);
            println();

            circuit.write(1, nts.Tristate.TRUE);
            circuit.write(2, nts.Tristate.TRUE);
            circuit.simulate();
            displayPins(nts, circuit);
            println();

            print("Deleting circuit...");
            circuit.delete();
            println(" ok");
        }

        async function main() {
            const nts = await createNts();

            formatNtsSource();
            runDemo(nts);

            runBtn.onclick = () => runDemo(nts);
            sourceElem.oninput = () => {
                sourceElem.style.height = "5px";
                sourceElem.style.height = `${sourceElem.scrollHeight}px`;
            };

            sourceElem.style.height = "5px";
            sourceElem.style.height = `${sourceElem.scrollHeight}px`;

            // we expose nts globally to try it out in the console :)
            window.nts = nts;
        }

        main();
    </script>

</body>

</html>
